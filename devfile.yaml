schemaVersion: 2.1.0
metadata:
  name: PresenzeAssenzeEntrate
projects:
  # My development project
  - name: presasse
    git:
      checkoutFrom:
        remote: origin
        revision: 'codeready-dev'
      remotes:
        origin: 'http://alm.sogei.it/tfs/SIFEntrate1Collection/TP-ENT-SA-0147/_git/PresenzeAssenzeEntrate'
      # The base project required to the WebSphere dev environemnt!
        wasbase: 'https://Sogei-POC@dev.azure.com/Sogei-POC/Sandbox-Dev-Sogei/_git/devspace-wasbase'
components:
  - name: maven
    container:
      image: 'registry.redhat.io/codeready-workspaces/plugin-java8-rhel8:2.15'
      volumeMounts:
        - name: m2
          path: /home/jboss/.m2
        - name: wasconfig
          path: /work/config
      # This volume contains application specific configuration files
        - name: installedapps
          path: /prod/installedApps
      endpoints:
      - name: 8080-tcp
        targetPort: 8080
      memoryLimit: 1Gi
      env:
      - value: '-XX:MaxRAMPercentage=50.0 -XX:+UseParallelGC -XX:MinHeapFreeRatio=10 -XX:MaxHeapFreeRatio=20 -XX:GCTimeRatio=4 -XX:AdaptiveSizePolicyWeight=90 -Dsun.zip.disableMemoryMapping=true -Xms512m  -Xmx2048m -Djava.security.egd=file:/dev/./urandom -Duser.home=/home/jboss'
        name: JAVA_OPTS
      - value: $(JAVA_OPTS)
        name: MAVEN_OPTS
      # Nome della cartella in cui copiare le configurazioni del WAS
      # esempio: se la cartella si trova in /prod/installedApps/PresenzeAssenzeEntrate,
      # il valore della variabile dovrà essere "PresenzeAssenzeEntrate"
      - value: "PresenzeAssenzeEntrate"
        name: APP_CONFIG_DIR_NAME
      # path della directory in cui sono salvati i file di configurazione del WAS
      - name: APP_CONFIG_SRC_DIR_PATH
        value: "/projects/presasse/Documentazione/prod/installedApps/PresenzeAssenzeEntrate"
  - name: wasbase
    container:
      image: 'ibmcom/websphere-traditional:9.0.5.12-ubi'
      env:
      # Nome della cartella in cui copiare le configurazioni del WAS
      # esempio: se la cartella si trova in /prod/installedApps/PresenzeAssenzeEntrate,
      # il valore della variabile dovrà essere "PresenzeAssenzeEntrate"
      - name: APP_CONFIG_DIR_NAME
        value: "PresenzeAssenzeEntrate"
      # Property opzionale per definire la password della console ad un valore predefinito.
      # In questo modo si evita che venga definita in maniera random ad ogni riavvio del workspace.
      - name: CUSTOM_CONSOLE_PSW
        value: "wsadmin"
      memoryLimit: 3Gi

      volumeMounts:
      # This volume is required to enable profiles command (manageprofile.sh) to not fail!
      - name: profilenable
        path: /workspace
      # This volume will contains the artifacts produced by the build and to be deployed in the server.
      - name: wasconfig
        path: /work/config
      # Thsi volume overwrites the defautl server to make it persistent!
      - name: wasprofile
        path: /opt/IBM/WebSphere/AppServer/profiles/AppSrv01
      - name: wasetc
        path: /etc/websphere
      # This volume contains application specific configuration files
      - name: installedapps
        path: /prod/installedApps
      endpoints:
      - name: apps
        targetPort: 9080
        attributes:
          discoverable: 'true'
          public: 'true'
          protocol: 'http'
          path: /presenzeAssenzeEntrate/login.jsp
      - name: was
        targetPort: 9043
        attributes:
          discoverable: 'true'
          public: 'true'
          protocol: 'https'
      command: ['sleep']
      args: ['infinity']
  
  - name: service-myapp
    openshift:
      inlined: |
        apiVersion: v1
        kind: Service
        metadata:
          name: myapp
          labels:
            app: my-app
        spec:
          ports:
          - name: 9080-tcp
            port: 80
            targetPort: 9080

  - name: route-myapp
    openshift: 
      inlined: |
        apiVersion: route.openshift.io/v1
        kind: Route
        metadata:
          annotations:
            openshift.io/host.generated: "true"
            haproxy.router.openshift.io/timeout: 10m
          labels:
            app: my-app
          name: debug
        spec:
          host: debug-presasse.apps.devspace.sogeiaz.it
          port:
            targetPort: "9080-tcp"
          tls:
            insecureEdgeTerminationPolicy: Redirect
            termination: edge
          to:
            kind: Service
            name: myapp
            weight: 100
          wildcardPolicy: None
commands:
  - id: initdefaultprofile
    exec:
      component: wasbase
      commandLine: scripts/restore_profile.sh ${CHE_PROJECTS_ROOT}/wasbase/scripts/profile90.bck ${CHE_PROJECTS_ROOT}/wasbase/scripts/server-cfg90.props
      workingDir: ${CHE_PROJECTS_ROOT}/wasbase
  - id: startserver
    exec:
      component: wasbase
      commandLine: scripts/start.sh
      workingDir: ${CHE_PROJECTS_ROOT}/wasbase
  - id: stopserver
    exec:
      component: wasbase
      commandLine:  scripts/stop.sh
      workingDir: ${CHE_PROJECTS_ROOT}/wasbase
  - id: deployall
    exec:
      component: wasbase
      commandLine: /projects/presasse/was/deploy.sh
      workingDir: ${CHE_PROJECTS_ROOT}/wasbase
  - id: deployelaborazioni
    exec:
      component: wasbase
      commandLine: /projects/presasse/was/deploy.sh elaborazioni
      workingDir: ${CHE_PROJECTS_ROOT}/wasbase
  - id: deploystampe
    exec:
      component: wasbase
      commandLine: /projects/presasse/was/deploy.sh stampe
      workingDir: ${CHE_PROJECTS_ROOT}/wasbase
  - id: deploytimbrature
    exec:
      component: wasbase
      commandLine: /projects/presasse/was/deploy.sh timbrature
      workingDir: ${CHE_PROJECTS_ROOT}/wasbase
  - id: deployfrontend
    exec:
      component: wasbase
      commandLine: /projects/presasse/was/deploy.sh frontend
      workingDir: ${CHE_PROJECTS_ROOT}/wasbase
  - id: tailsystemout
    exec:
      component: wasbase
      commandLine:  tail -n100 -f  /opt/IBM/WebSphere/AppServer/profiles/AppSrv01/logs/server1/SystemOut.log
      workingDir: ${CHE_PROJECTS_ROOT}/wasbase
  - id: tailsystemerr
    exec:
      component: wasbase
      commandLine:  tail -n100 -f  /opt/IBM/WebSphere/AppServer/profiles/AppSrv01/logs/server1/SystemErr.log
      workingDir: ${CHE_PROJECTS_ROOT}/wasbase
  - id: showconsolecredentials
    exec:
      component: wasbase
      commandLine:   bash show_credentials.sh
      workingDir: ${CHE_PROJECTS_ROOT}/wasbase/scripts

  # actions on component maven
  - id: initbuildcontext
    exec:
      workingDir: '${CHE_PROJECTS_ROOT}/presasse/was'
      commandLine: 'chmod +x *.sh && ./init.sh'
      component: maven
  - id: buildall
    exec:
      workingDir: '${CHE_PROJECTS_ROOT}/presasse/was'
      commandLine: './build-all.sh'
      component: maven
  - id: buildelaborazioni
    exec:
      workingDir: '${CHE_PROJECTS_ROOT}/presasse/was'
      commandLine: './build-all.sh elaborazioni'
      component: maven
  - id: buildstampe
    exec:
      workingDir: '${CHE_PROJECTS_ROOT}/presasse/was'
      commandLine: './build-all.sh stampe'
      component: maven
  - id: buildtimbrature
    exec:
      workingDir: '${CHE_PROJECTS_ROOT}/presasse/was'
      commandLine: './build-all.sh timbrature'
      component: maven
  - id: buildfrontend
    exec:
      workingDir: '${CHE_PROJECTS_ROOT}/presasse/was'
      commandLine: './build-all.sh frontend'
      component: maven

  # - id: 5 Debug (Attach)
  #   exec:
  #     - referenceContent: |
  #         {
  #         "version": "0.2.0",
  #         "configurations": [
  #         {
  #             "type": "java",
  #             "request": "attach",
  #             "name": "Debug (Attach)",
  #             "hostName": "localhost",
  #             "port": 7777
  #         }
  #         ]
  #         }
  #       type: vscode-launch
    # events:
    #  postStart:
